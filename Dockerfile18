FROM ubuntu:18.04 AS osmp_builder
MAINTAINER bjoern.bahn@dlr.de

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y build-essential python3-pip git && rm -rf /var/lib/apt/lists/*

RUN python3 -m pip install --upgrade pip
RUN pip3 install --upgrade cmake

RUN pip3 install conan==1.59.0

RUN mkdir osmpservice && mkdir osmpservice/build
WORKDIR /osmpservice/build
COPY . /osmpservice/

RUN cmake .. -DBUILD_SHARED_LIBS=false -DCMAKE_BUILD_TYPE=Release
RUN cmake --build . --target OSMPService -j 4

FROM ubuntu:18.04
RUN apt-get update && apt-get install -y libprotobuf10 && rm -rf /var/lib/apt/lists/*
COPY --from=osmp_builder /osmpservice/build/bin/OSMPService .
ENTRYPOINT ./OSMPService
